name: Sync Google Drive â†’ GitHub

on:
  workflow_dispatch:
  schedule:
    # Runs every day at 02:00 UTC
    - cron: "0 2 * * *"

permissions:
  contents: read

jobs:
  sync-drive:
    name: Sync Google Drive assets into repo
    runs-on: ubuntu-latest

    env:
      SYNC_BRANCH: main
      SYNC_DIR: drive-sync
      RCLONE_CONFIG_PATH: ${{ github.workspace }}/rclone.conf

      TEAM_DRIVE_ID: 0ADiUEtEuadcKUk9PVA
      DRIVE_SOURCE_PATH: Brand

    steps:
      - name: Checkout repository using PAT (write-enabled)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          persist-credentials: false
          ref: ${{ env.SYNC_BRANCH }}

      - name: Set up Git identity
        run: |
          git config user.name "defi-app-bot"
          git config user.email "brand-bot@defi.app"

      - name: Install rclone
        shell: bash
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Configure rclone for Google Drive (service account)
        shell: bash
        run: |
          echo "${{ secrets.SERVICE_ACCOUNT_JSON }}" | base64 --decode > service-account.json
          cat > "${RCLONE_CONFIG_PATH}" <<EOF
          [gdrive]
          type = drive
          scope = drive.readonly
          service_account_file = service-account.json
          team_drive = ${TEAM_DRIVE_ID}
          EOF

          rclone --config "${RCLONE_CONFIG_PATH}" about gdrive:

      - name: Sync from Google Drive to temporary directory
        shell: bash
        run: |
          mkdir -p "${SYNC_DIR}"
          rclone --config "${RCLONE_CONFIG_PATH}" sync "gdrive:${DRIVE_SOURCE_PATH}" "${SYNC_DIR}" \
            --fast-list \
            --transfers 8 \
            --checkers 16 \
            --delete-excluded \
            --verbose

      - name: Move synced files to root and cleanup
        shell: bash
        run: |
          rsync -av --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='rclone.conf' \
            --exclude='service-account.json' \
            --exclude='drive-sync/' \
            "./${SYNC_DIR}/" "./"
          
          # Clean up the temporary sync directory
          rm -rf "${SYNC_DIR}"

      - name: Commit changes (if any)
        id: commit_status
        shell: bash
        run: |
          echo "service-account.json" >> .gitignore
          echo "rclone.conf" >> .gitignore
          
          git add -A

          if git diff --cached --quiet; then
            echo "status=no_changes" >> "$GITHUB_OUTPUT"
            echo "No changes to commit."
            exit 0
          fi

          COMMIT_MSG="chore(sync): update brand assets from Google Drive"
          git commit -m "${COMMIT_MSG}"
          echo "status=committed" >> "$GITHUB_OUTPUT"

      - name: Push changes using PAT
        if: steps.commit_status.outputs.status == 'committed'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        shell: bash
        run: |
          if [ -z "${GH_PAT}" ]; then
            echo "Missing secret: GH_PAT" >&2
            exit 1
          fi

          git remote set-url origin "https://appdefi:${GH_PAT}@github.com/defi-app/brand.git"
          git push origin "HEAD:${SYNC_BRANCH}"

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f service-account.json rclone.conf
